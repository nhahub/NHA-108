
# ================================================
# ğŸ§© Supply Chain Analysis Project (Cleaning Part)

# Import Libraries 
import os
import pandas as pd
import numpy as np

# Load Dataset 
file_path = r"C:\Users\morom\OneDrive\Desktop\Final Project\supply_chain_data_new.csv"  
df = pd.read_csv(file_path)

print("âœ… Data Loaded Successfully")
print("Shape:", df.shape)
df.head()

# Standardize Column Names 
df.columns = (
    df.columns
      .str.strip()             # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
      .str.lower()             # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø±ÙˆÙ Ø¥Ù„Ù‰ ØµØºÙŠØ±Ø©
      .str.replace(" ", "_")   # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨Ø´Ø±Ø·Ø© Ø³ÙÙ„ÙŠØ© _
)

print("\nâœ… Column names standardized:")
print(df.columns.tolist())

# === 4ï¸âƒ£ Remove Duplicate Rows ===
before = df.shape[0]
df.drop_duplicates(inplace=True)
after = df.shape[0]

print(f"\nâœ… Removed {before - after} duplicate rows")

# === 5ï¸âƒ£ Detect Hidden Missing Values ===
# Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù†ØµÙŠØ© Ù…Ø«Ù„ 'N/A' Ø£Ùˆ 'na' Ø¨Ù€ NaN
df.replace(["N/A", "n/a", "NA", "na", "?", "None", ""], np.nan, inplace=True)

# Ù…Ù„Ø®Øµ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
missing_summary = df.isnull().sum()
print("\nğŸ” Missing Values Summary:")
print(missing_summary[missing_summary > 0])

# === 6ï¸âƒ£ Handle Missing Values ===
# Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠØ© â†’ Ø¨Ø§Ù„Ù€ median
# Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù†ØµÙŠØ© â†’ Ø¨Ø§Ù„Ù€ mode
for col in df.columns:
    if df[col].isnull().sum() > 0:
        if df[col].dtype in ["float64", "int64"]:
            df[col].fillna(df[col].median(), inplace=True)
        else:
            df[col].fillna(df[col].mode()[0], inplace=True)

print("\nâœ… Missing values handled.")

# === 7ï¸âƒ£ Fix Data Types ===
# Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù…Ù† Ù†ÙˆØ¹ Ø±Ù‚Ù…ÙŠ ÙØ¹Ù„Ø§Ù‹
numeric_cols = df.select_dtypes(include=["object"]).columns

for col in numeric_cols:
    try:
        df[col] = pd.to_numeric(df[col])
    except:
        pass

print("\nâœ… Data types checked and corrected where possible.")

# === 8ï¸âƒ£ Detect and Handle Outliers ===
# Ø·Ø±ÙŠÙ‚Ø© IQR Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø´Ø§Ø°Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
numeric_columns = df.select_dtypes(include=[np.number]).columns

def remove_outliers_iqr(df, column):
    Q1 = df[column].quantile(0.25)
    Q3 = df[column].quantile(0.75)
    IQR = Q3 - Q1
    lower = Q1 - 1.5 * IQR
    upper = Q3 + 1.5 * IQR
    
    # Ù†Ø³ØªØ®Ø¯Ù… clip Ø¨Ø¯Ù„ Ø­Ø°Ù Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ
    df[column] = np.clip(df[column], lower, upper)

for col in numeric_columns:
    remove_outliers_iqr(df, col)

print("\nâœ… Outliers capped using IQR method.")

#  Validate Business Logic 
# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: revenue â‰ˆ price * number_of_products_sold
df["revenue_check"] = df["price"] * df["number_of_products_sold"]

inconsistent_rows = (
    np.abs(df["revenue_generated"] - df["revenue_check"]) > 
    0.05 * df["revenue_generated"]
).sum()

print(f"\nğŸ” Inconsistent revenue entries: {inconsistent_rows}")

# Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
df.drop(columns=["revenue_check"], inplace=True, errors="ignore")

#  Save Cleaned Dataset 
cleaned_path = "supply_chain_data_cleaned.csv"
df.to_csv(cleaned_path, index=False)

print(f"\nâœ… Cleaned data saved as '{cleaned_path}'")
print("Final shape:", df.shape)

# Final Verification 
df.info()
df.head()

#  Confirm Save Path 
cleaned_path = os.path.join(os.getcwd(), "supply_chain_data_cleaned.csv")
print("âœ… Cleaned file saved at:", cleaned_path)


-- =========================================================
-- ğŸ“Š Supply Chain KPIs Dashboard Queries (KPIS Part)
-- Table: supply_chain_data_cleaned
-- =========================================================

-- 1ï¸âƒ£ Ù…ØªÙˆØ³Ø· Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆØ§Ù„ØªØµÙ†ÙŠØ¹ Ø­Ø³Ø¨ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…Ø³Ø§Ø±
SELECT 
    transportation_modes,
    routes,
    ROUND(AVG(lead_time), 2) AS Avg_Lead_Time,
    ROUND(AVG(manufacturing_lead_time), 2) AS Avg_Manufacturing_Lead_Time
FROM supply_chain_data_cleaned
GROUP BY transportation_modes, routes
ORDER BY Avg_Lead_Time DESC;


-- 2ï¸âƒ£ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆÙ…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ ÙˆØ³ÙŠÙ„Ø© Ù†Ù‚Ù„
SELECT 
    transportation_modes,
    ROUND(SUM(costs), 2) AS Total_Costs,
    ROUND(AVG(costs), 2) AS Avg_Cost_Per_Shipment
FROM supply_chain_data_cleaned
GROUP BY transportation_modes
ORDER BY Total_Costs DESC;


-- 3ï¸âƒ£ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø¬Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ÙˆÙ…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© Ø§Ù„ØªØµÙ†ÙŠØ¹ Ù„ÙƒÙ„ Ù…ÙˆÙ‚Ø¹
SELECT 
    location,
    ROUND(SUM(production_volumes), 2) AS Total_Production,
    ROUND(AVG(manufacturing_costs), 2) AS Avg_Manufacturing_Cost
FROM supply_chain_data_cleaned
GROUP BY location
ORDER BY Total_Production DESC;


-- 4ï¸âƒ£ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¹ÙŠØ¨Ø© (Defect Rate %) Ù„ÙƒÙ„ Ù…ÙˆÙ‚Ø¹
SELECT 
    location,
    ROUND(AVG(defect_rates) * 100, 2) AS Avg_Defect_Rate_Percent
FROM supply_chain_data_cleaned
GROUP BY location
ORDER BY Avg_Defect_Rate_Percent DESC;


-- 5ï¸âƒ£ Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ­Øµ Ø§Ù„Ù†Ø§Ø¬Ø­ (Inspection Pass Rate)
-- ÙŠÙØªØ±Ø¶ Ø£Ù† inspection_results ÙÙŠÙ‡Ø§ Ù‚ÙŠÙ… Ù…Ø«Ù„ 'Pass' Ùˆ 'Fail'
SELECT 
    ROUND(
        SUM(CASE WHEN inspection_results = 'Pass' THEN 1 ELSE 0 END) * 100.0 / COUNT(*),
        2
    ) AS Pass_Rate_Percent
FROM supply_chain_data_cleaned;


-- 6ï¸âƒ£ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Route
SELECT 
   
   routes,
    ROUND(AVG(costs), 2) AS Avg_Cost,
    ROUND(AVG(lead_time), 2) AS Avg_Lead_Time,
    ROUND(AVG(defect_rates) * 100, 2) AS Avg_Defect_Rate_Percent
FROM supply_chain_data_cleaned
GROUP BY  routes
ORDER BY Avg_Cost DESC;


-- 7ï¸âƒ£ Ø£Ù‡Ù… 3 Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ø¥Ù†ØªØ§Ø¬
SELECT 
    location,
    SUM(production_volumes) AS Total_Production
FROM supply_chain_data_cleaned
GROUP BY location
ORDER BY Total_Production DESC
LIMIT 3;


-- 8ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù†Ù‚Ù„
SELECT 
    transportation_modes,
    ROUND(AVG(lead_time), 2) AS Avg_Lead_Time,
    ROUND(AVG(manufacturing_costs), 2) AS Avg_Manufacturing_Cost,
    ROUND(AVG(costs), 2) AS Avg_Total_Cost,
    ROUND(AVG(defect_rates) * 100, 2) AS Avg_Defect_Rate_Percent
FROM supply_chain_data_cleaned
GROUP BY transportation_modes
ORDER BY Avg_Total_Cost DESC;


